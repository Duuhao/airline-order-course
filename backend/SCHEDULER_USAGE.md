# 定时任务使用说明

## 概述

航空订单管理系统包含多个定时任务，用于自动化处理订单状态转换、超时处理、重试机制等业务逻辑。

## 定时任务列表

### 1. 超时订单检查 (checkTimeoutOrders)

**执行频率**: 每分钟执行一次  
**功能**: 检查超过30分钟未支付的订单，自动取消这些订单  
**分布式锁**: 使用ShedLock确保分布式环境下只有一个实例执行  
**配置参数**: `order.timeout.minutes=30`

**业务逻辑**:
- 查找状态为 `PENDING_PAYMENT` 且创建时间超过30分钟的订单
- 自动将这些订单状态更新为 `CANCELLED`
- 记录处理结果日志

### 2. 出票失败重试 (retryFailedTicketing)

**执行频率**: 每5分钟执行一次  
**功能**: 自动重试出票失败的订单  
**分布式锁**: 使用ShedLock确保分布式环境下只有一个实例执行  
**配置参数**: `ticketing.retry.max-attempts=3`

**业务逻辑**:
- 查找状态为 `TICKETING_FAILED` 的订单
- 重新开始出票流程，将状态更新为 `TICKETING_IN_PROGRESS`
- 添加1秒延迟避免过于频繁的请求
- 记录重试结果日志

### 3. 订单状态统计 (orderStatusStatistics)

**执行频率**: 每30分钟执行一次  
**功能**: 统计各状态订单数量，用于监控和报表  
**分布式锁**: 使用ShedLock确保分布式环境下只有一个实例执行

**业务逻辑**:
- 统计所有订单状态的数量
- 输出统计结果到日志
- 可用于监控系统状态

### 4. 长时间出票订单检查 (checkStuckTicketingOrders)

**执行频率**: 每3分钟执行一次  
**功能**: 检查长时间处于出票中状态的订单  
**分布式锁**: 使用ShedLock确保分布式环境下只有一个实例执行

**业务逻辑**:
- 查找状态为 `TICKETING_IN_PROGRESS` 且超过10分钟的订单
- 记录警告日志，提示可能需要人工干预
- 可用于告警系统

### 5. 锁记录清理 (cleanupExpiredLocks)

**执行频率**: 每天凌晨2点执行  
**功能**: 清理过期的ShedLock记录  
**分布式锁**: 使用ShedLock确保分布式环境下只有一个实例执行

**业务逻辑**:
- ShedLock会自动清理过期的锁记录
- 主要用于记录清理日志

## 配置参数

在 `application.yml` 中配置以下参数：

```yaml
# 定时任务配置
order:
  timeout:
    minutes: 30  # 订单超时时间（分钟）
ticketing:
  retry:
    max-attempts: 3  # 出票重试最大次数
```

## 手动触发接口

系统提供了手动触发定时任务的REST接口，方便测试和紧急处理：

### 1. 手动触发超时订单检查
```
POST /scheduler/check-timeout-orders
```

### 2. 手动触发出票失败重试
```
POST /scheduler/retry-failed-ticketing
```

### 3. 手动触发订单状态统计
```
POST /scheduler/order-statistics
```

### 4. 手动触发长时间出票订单检查
```
POST /scheduler/check-stuck-ticketing
```

### 5. 获取定时任务状态
```
GET /scheduler/status
```

## 分布式锁机制

所有定时任务都使用ShedLock分布式锁，确保在分布式环境下：

1. **唯一执行**: 同一时间只有一个实例执行任务
2. **锁超时**: 设置合理的锁超时时间，避免死锁
3. **自动清理**: 自动清理过期的锁记录

### 锁配置说明

- `lockAtLeastFor`: 任务最少执行时间，防止任务执行过快
- `lockAtMostFor`: 任务最大执行时间，防止任务卡死

## 监控和日志

### 日志级别
- 定时任务执行开始和结束
- 处理结果统计（成功/失败数量）
- 错误异常记录
- 警告信息（如长时间出票订单）

### 监控指标
- 各状态订单数量统计
- 任务执行频率
- 任务执行成功率
- 异常情况告警

## 注意事项

1. **数据库连接**: 确保数据库连接池配置合理，支持并发查询
2. **事务管理**: 定时任务中的数据库操作使用 `@Transactional` 注解
3. **异常处理**: 每个任务都有完整的异常处理机制
4. **性能考虑**: 大量数据处理时添加适当的延迟和分批处理
5. **监控告警**: 建议配置监控系统，及时发现异常情况

## 扩展建议

1. **邮件通知**: 可以添加邮件通知功能，在发现异常时发送告警邮件
2. **重试策略**: 可以实现更复杂的重试策略，如指数退避
3. **动态配置**: 可以通过配置中心动态调整定时任务参数
4. **任务暂停**: 可以添加任务暂停/恢复功能
5. **执行历史**: 可以记录任务执行历史，便于问题排查 